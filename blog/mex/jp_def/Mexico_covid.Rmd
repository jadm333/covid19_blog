---
title: "Ociosidad en tiempos de COVID-19 (2019-nCoV)"
author:
- affiliation: UHN, Toronto, ON, Canada
  affiliation_url: https://thebru.ca/Juan_Pablo_Diaz_Martinez
  name: Juan Pablo Díaz Martínez
date: "Mar 28, 2020"
description: Algunos comentarios de lo que pasa en México con respecto a esta enfermedad
creative_commons: CC BY-SA
output:
  distill::distill_article:
    self_contained: no
    toc: yes
    toc_depth: 2
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE,
                      tidy.opts=list(width.cutoff=60),
                      tidy=TRUE)
library(tidyverse)
library(lubridate)
library(countrycode)
library(ggrepel)
library(prismatic)
library(ggsci)
library(paletteer)
library(incidence)
library(EpiEstim)
library(projections)
library(epitrix)
library(distcrete)
library(magrittr)

setwd("C:/Users/juand/OneDrive/Documents/Covid Mexico")

countries<-c("ITA","ESP","USA","MEX")

confirmed_raw <- read_csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv", col_types = cols())
deaths_raw <- read_csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_deaths_global.csv", col_types = cols())

confirmed_data<-confirmed_raw %>%
  select(-Lat, -Long) %>%
  rename(country = `Country/Region`,Province_Re=`Province/State`) %>%
  mutate(iso3c = countrycode(country,
                             origin = "country.name",
                             destination = "iso3c")) %>%
  select(-country) %>%
  filter(iso3c %in% countries) %>% 
  pivot_longer(
    c(-Province_Re,-iso3c), 
    names_to = "date_str", 
    values_to = "confirmed"
  ) %>%
  mutate(date = mdy(date_str)) %>%
  group_by(Province_Re)  %>% 
  mutate(new_confirmed=c(0,diff(confirmed)))  %>% ungroup() %>%
  select(iso3c,Province_Re, date,confirmed,new_confirmed) 

deaths_data<-deaths_raw %>%
  select(-Lat, -Long) %>%
  rename(country = `Country/Region`,Province_Re=`Province/State`) %>%
  mutate(iso3c = countrycode(country,
                             origin = "country.name",
                             destination = "iso3c")) %>%
  select(-country) %>%
  filter(iso3c %in% countries) %>% 
  pivot_longer(
    c(-Province_Re,-iso3c), 
    names_to = "date_str", 
    values_to = "deaths"
  ) %>%
  mutate(date = mdy(date_str)) %>%
  group_by(Province_Re)  %>% 
  mutate(new_deaths=c(0,diff(deaths)))  %>% ungroup() %>%
  select(iso3c,Province_Re, date,deaths,new_deaths) 


data_covid <- confirmed_data %>%
  full_join(deaths_data, by = c("iso3c","Province_Re", "date")) %>% mutate(date=if_else(iso3c=="MEX",date-1,date))

ontario<-data_covid %>% filter(Province_Re=="Ontario") %>%
  mutate(iso3c="Ontario")
```

# Introducción

Este post nace despúes de 2 semanas de distanciamento social en Toronto, Canadá. Para los que no me conocen, actualmente soy doctorante en la Universidad de Toronto donde mi línea de investigación es el aprendizaje estadístico como herramienta de predicción en enfermedades que tienden a progresar a a través del tiempo (e.g. cáncer). Cuento con una posición de "Bioestadístico" en [University Health Network](https://www.uhn.ca/corporate/AboutUHN) el cual aglomera diferentes hospitales para una mejor colabaración en diferentes temas de investigación.

Es importante notar que este post no ha sido revisado por pares y que mi linea de investigación no es el modelaje de epidemias como la que vivimos ahorita. Este post tiene como objetivo discutir algunos aspectos importantes de la epidemia en nuestro país y hacer unas predicciones sencillas de lo que está por venir. Es importante notar que este análisis usa datos que se han capturado hasta Marzo 28. El link para el código de este post se encuentre en un repositorio de Github el cuál podrán encontrar al final de este post; las gráficas y el análisis fueron hechos en `R`, utilizando en su mayoría librerías como `dplyr`, `ggplot2` y una serie de librerías que están aglomeradas en [**R** **E**pidemics **Con**sortium (**RECON**) suite](https://www.repidemicsconsortium.org).

# Epidemia en México

Mucho se ha hablado en las conferencias vespertinas relacionadas a COVID-19 acerca del número de casos nuevos desde que la epidemia llegó a nuestro país y si el gobierno ha hecho pruebas suficientes. Antes de describir de cualquier análisis es importante describir dos aspectos importrantes respecto a las características epidemiológicas en nuestro país:
1. Cómo funciona el sistema epidemiológico
2. Como se alimenta diariamente el número de casos confirmados 

## Sistema epidemiológico en México

El Dr. Hugo López Gatell ha mencionada en muchísimas ocasiones como funciona el sistema centinela en nuestro país (la siguiente [entrevista](https://elpais.com/sociedad/2020-03-26/lopez-gatell-en-mexico-queremos-un-balance-entre-proteger-la-salud-y-a-las-economias-mas-debilitadas.html) es muestra de lo anterior). A manera de resumen, la idea del programa es que “en vez de recopilar grandes cantidades de datos de calidad deficiente, hay que concentrarse en recopilar datos de buena calidad de un número reducido de centros centinela seleccionados cuidadosamente”, de acuerdo al documento de la [OMS](https://www.paho.org/revelac-i/wp-content/uploads/2015/10/2015-cha-guia-operativa-vigilancia-centinela-irag.pdf) actualizado en 2014. El proceso es buscar COVID-19 en pacientes negativos a la prueba de influenza para ver si hay transmisión comunitaria; Alberto Díaz Cayeros hace una descripción de éste y discute posibles fallas que pueden ocurrir en este [sistema](https://medium.com/@adiazcayeros/the-balancing-act-in-mexicos-covid-19-response-a6955ec629fc).

Este sistema funcionó para H1N1 en el 2009 y todos esperamos que funcione para COVID-19. ¿Por qué utilizar este sistema y no pruebas masivas como lo hizo Corea del Sur? Creo que es por dos razones: el sistema ha funcionado y es eficiente debido las limitaciones de recursos en Salud en nuestro país. Es importante aclarar que estas limitaciones no son nuevas y es producto de un porcentaje muy bajo del gasto en el sector salud como porcentaje del PIB durante varios años de acuerdo a la [OCDE](https://stats.oecd.org/).

## Casos confirmados

El 28 de febrero fue confirmado el primer paciente con COVID-19 en nuestro país. Desde el 23 de marzo se han [modificado](https://lopezdoriga.com/nacional/modifica-salud-criterios-para-identificacion-de-casos-sospechosos-por-covid-19/) los criterios operacionales para la vigilancia epidemiológica de COVID-19. Como se ha mencionado en diferentes medio de comunicación (nota [aquí](https://www.elfinanciero.com.mx/nacional/al-10-de-los-casos-sospechosos-de-covid-19-con-sintomas-leves-se-les-aplica-prueba-imss)) la definición es la siguiente:

* Caso sospechoso - Persona de cualquier edad que en los últimos siete días haya presentado al menos dos síntomas de tos, fiebre o cefalea, es decir, dolor de cabeza intenso y persistente y que esté acompañado de los siguientes signos: dificultad para respirar, hinchazón en articulaciones con dificultad de movimiento, dolor muscular, ardor de garganta, rinorrea, conjuntivitis y dolor de tórax.

* Caso confirmado - Persona que cumpla lo anterior y que cuente con confirmación del InDRE.

Asimismo, se modificó el porcentaje de muestreo para vigilar los casos de COVID-19. Solo se realizará la prueba al 10% de los casos sospechosos sin síntomas o síntomas leves. A su vez, se realizará la prueba al 100% de los casos sospechosos con sintomología grave o que cumplan con la definición infección respiratoria aguda grave (IRAG). Es importante recalcar que el gobierno ha recalcado que **todos los casos sospechosos sin importar si se les realizó la prueba deberán de permanecer en aislamiento **.

# Análisis de la epidemia en México

Antes de presentar datos y gráficas me gustaría enfatizar en **2 aspectos importantes al considerar la presentación y análisis de datos de casos confirmados con COVID-19**:

1. La comparación entre países (e.g. incidencia acumulada) debe de realizarse con mucho cuidado. Esto debido a lo expuesto en la sección anterior; los países tienen distintos sistemas epidemiológicos y diferentes recursos, por lo tanto la cantidad de casos confirmados está en función de la cantidad de pruebas que puedan realizar. Es muy importante recalcar esto ya que esta comparación es la que más noticias engañosas y falsas que al menos yo he encontrado en redes sociales (ver [aquí](https://twitter.com/samuel_garcias/status/1243696094682456068)).
2. La comparación entre países debe de realizarze desde un punto en común en el tiempo ya que la epidemia entra a cada país en momentos distintos. Esto tiene mucha importancia sobre todo al presentar gráficas e ilustraciones ya sea para mostrar la incidencia (casos nuevos) o incidencia acumulada.

¿Qué sí podemos rescatar cuando comparamos casos confirmados entre diferentes países?. La siguiente gráfica muestra el número de casos confirmados acumulados con COVID-19 desde que se comfirmó el paciente número 100. Decidí transformar el eje de las $y$ al aplicarle el logaritmo base 2; esta transformación ayuda a una mejor interpretación de los datos ya que es más fácil para el lector ver cuanto tiempo se tarda un país en tener el doble de casos confirmados en un periodo determinado de tiempo. Asimismo al transformar los datos la serie de tiempo presenta un comportamiento más lneal.

```{r acum_casos, message=FALSE, warning=FALSE, tidy=TRUE,fig.width=10, fig.height=8}
 data_covid  %>% 
   group_by(iso3c,date) %>%
   summarise_at(vars(-Province_Re),funs(sum)) %>% filter(confirmed > 99) %>%
   mutate(days_elapsed = date - min(date),
          end_label = ifelse(date == max(date),iso3c, NA)) %>%
   ggplot(mapping = aes(x = days_elapsed, y = confirmed,label=end_label,
                        color = iso3c, alpha=iso3c,
                        group = iso3c)) + 
   geom_line(size = 0.8) +scale_alpha_manual(values=c(1,1,1,1,1,1,1,0.3,1))+
   geom_text_repel(nudge_x = 1.1,
                   nudge_y = 0.1, 
                   segment.color = NA) + 
   guides(color = FALSE,alpha=F) + 
   scale_color_manual(values = prismatic::clr_darken(paletteer_d("ggsci::category20_d3"), 0.2)) +
   scale_y_continuous(labels = scales::comma_format(accuracy = 1),
                      trans = "log2",n.breaks = 10) +  
   scale_x_continuous(n.breaks = 10) +
   labs(x = "Días desde el caso número 100", 
        y = "Número acumulado de casos confirmados (escala log2)", 
        title = "Número acumulado de casos confirmados por COVID-19", 
        caption = "Juan Pablo Díaz @juandiazmart / Data: Repo John H.",
        subtitle = paste("Datos hasta", format(max(data_covid$date), "%b %e, %Y"))) + 
   theme(plot.title = element_text(size = rel(2), face = "bold"),
         plot.subtitle = element_text(size = rel(1.5)),
         axis.text.y = element_text(size = rel(2)),
         axis.title.x = element_text(size = rel(1.5)),
         axis.title.y = element_text(size = rel(1.5)),
         axis.text.x = element_text(size = rel(2)),
         legend.text = element_text(size = rel(2)),
         panel.grid.major = element_line(colour = "grey90", size = .1),
         panel.background = element_blank(),
         axis.line = element_line(colour = "grey50", size = .9)) + 
   geom_abline(intercept =log2(118), slope = 1/7,linetype = "dashed")+
   annotate("text", label = "Casos incrementan \n al doble cada 7 días", x = 23, y = 1700,size=3)+
   geom_abline(intercept =log2(118), slope = 1/3,linetype = "dashed")+
   annotate("text", label = "Casos incrementan \n al doble cada 3 días", x = 21, y = 32000,size=3)
```

México desde que llegó el caso número 100 ha tenido un incremento al doble de casos confirmados cada 3 días, con una ligera pendiente menor después de 5 días desde que llegó a su caso 100. Al final es esta pendiente la que queremos que se haga 0, es decir, aplastarla para que la curva de casos acumulados se "aplane". Si queremos comparar países no nos fijemos en el número de casos acumulados. Fijémonos mejor en sus pendientes y como éstas cambian a través del tiempo. Si los procedimientos epidemiológicos descritos anterormente no cambian, la pendiente de México podría incrementar si por ejemplo aumentan considerablemente los casos graves.

Dado que es difícil comparar casos confirmados por todo lo explicado en párrafos previos, pienso que es más fácil comparar el número de muertes^[Recordemos que a todos los graves sí se les realiza la prueba]. La siguiente gráfica nos ayuda a entender el comportamiento de número de muertes acumuladas en nuestro país desde que se presentó la quinta muerta.

```{r acum_muerte, message=FALSE, warning=FALSE, tidy=TRUE,fig.width=10, fig.height=8}
 data_covid  %>% 
   group_by(iso3c,date) %>%
   summarise_at(vars(-Province_Re),funs(sum)) %>% filter(deaths > 4) %>%
   mutate(days_elapsed = date - min(date),
          end_label = ifelse(date == max(date),iso3c, NA)) %>%
   ggplot(mapping = aes(x = days_elapsed, y = deaths,label=end_label,
                        color = iso3c, alpha=iso3c,
                        group = iso3c)) + 
   geom_line(size = 0.8) +scale_alpha_manual(values=c(1,1,1,1,1,1,1,0.3,1))+
   geom_text_repel(nudge_x = 1.1,
                   nudge_y = 0.1, 
                   segment.color = NA) + 
   guides(color = FALSE,alpha=F) + 
   scale_color_manual(values = prismatic::clr_darken(paletteer_d("ggsci::category20_d3"), 0.2)) +
   scale_y_continuous(labels = scales::comma_format(accuracy = 1),
                      trans = "log2",n.breaks = 10) +  
   scale_x_continuous(n.breaks = 10) +
   labs(x = "Días desde el quinto deceso", 
        y = "Número acumulado de muertes (escala log2)", 
        title = "Número acumulado de muertes por COVID-19", 
        caption = "Juan Pablo Díaz @juandiazmart / Data: Repo John H.",
        subtitle = paste("Datos hasta", format(max(data_covid$date), "%b %e, %Y"))) + 
   theme(plot.title = element_text(size = rel(2), face = "bold"),
         plot.subtitle = element_text(size = rel(1.5)),
         axis.text.y = element_text(size = rel(2)),
         axis.title.x = element_text(size = rel(1.5)),
         axis.title.y = element_text(size = rel(1.5)),
         axis.text.x = element_text(size = rel(2)),
         legend.text = element_text(size = rel(2)),
         panel.grid.major = element_line(colour = "grey90", size = .1),
         panel.background = element_blank(),
         axis.line = element_line(colour = "grey50", size = .9)) + 
   geom_abline(intercept =log2(5), slope = 1/2,linetype = "dashed")+
   annotate("text", label = "Muertes incrementan \n al doble cada 2 días", x = 13, y = 1024,size=3)+
   geom_abline(intercept =log2(5), slope = 1/3,linetype = "dashed")+
   annotate("text", label = "Muertes incrementan \n al doble cada 3 días", x = 15, y = 64,size=3)
```

Estos datos son los que personalmente me preocupan ya que México podría llegar a 4,000 muertos aproximadamente 20 días después del quinto deceso si las muertes incremental al doble cada 2 días (mismo caso que España). Volvemos al punto central que discutí en los datos de casos confirmados, **lo importante es ver cuánto cambia la pendiente a través del tiempo**. Hay que tener en cuenta que muchas de las muertes no serán diagnosticadas como muertes por COVID-19 (eso pasa en México y en otros países), por eso mientras el aumento sea constante no habría de preocuparse por esta sub-estimación.


# Estimación del número de infectados y del impacto de Susana Distancia.

Debido a la naturaleza e importancia de la enfermedad, diferentes revistas indexadas en el mundo han acelerado su proceso de revisión para poder publicar diferentes artículos académicos referentes al SARS-COV 19. A mí siempre me han llamado la atención aquellos artículos que describen modelos de predicción. 

En la sección anterior mencioné que es mejor utilizar el número de muertes si queremos hacer algún tipo de comparación o inferencia. Algunas limitaciones de este número son:

1. Posible sub-estimación de muertes por COVID 19 - Esto debido a que habrá casos donde SARS-COV 19 no haya sido identificado.
2. Posible retraso en la captura de muertes - Hemos visto en algunas conferencias vespertinas casos donde la confirmación de SARS-COV 19 llega después del fallecimiento.

Estas limitaciones no afectarán ningún modelo o inferencia que se quiera realizar siempre y cuando ambas se mantengan constantes en el tiempo. 

¿De qué manera se puede estimar el número de infectados y el impacto de las medidas realizadas por el gobierno federal para incentivar el distanciamiento social? Utizando la historia natural de la enfermedad. El Imperial College de Reino Unido publicó el 30 de marzo un modelo [modelo de predicción](https://www.imperial.ac.uk/mrc-global-infectious-disease-analysis/covid-19/report-13-europe-npi-impact/) de muertes, infectados y efectos de diferentes medidas para "aplanar la curva". Con el fin de tener una mejor imagen de lo que pasa con COVID-19, el anterior modelo fue adaptado utilizando los datos oficiales reportados en nuestro país. La Figura 1 muestra el modelo de predicción.

```{r pressure, echo=FALSE, fig.cap="Forecast algorithm",fig.align="center"}
knitr::include_graphics("model.png")
```

El modelo utiliza las muertes observadas de acuerdo a los datos oficiales del gobierno de México.La Figura 1 muestra el nivel jerárquico (de abajo hacia arriba) que nos permite relacionar el impacto de diferentes intervenciones (i.e. cierre de escuelas,etc.) y las muertes observadas. Dada la relación que existe entre los diferentes parámetros a estimar, el modelo realiza la inferencia utilizando un enfoque Bayesiano mediante `stan`, un lenguaje de programación específco para inferencia Bayesiana. La relación entre los parámetros se explica a grandes razgos a continuación utilizando la misma notación que el modelo original.

## Muertes observadas

Día con día el gobierno federal nos infroma de el número de muertes observadas $D_t$ para los d+ias $t\in1,...,n$. Estas muertes diarias son modeladas utilizando el valor esperado de las muertes diarias, es decir, $d_t=\mathbf{E}[D_t]$. El modelo asume que $D_t$ tiene una distribución binomial negativa^[Asumo que utlizaron esta distribución para permitir la posible sobredispersión.] con los siguientes parámetros:

$$D_t\sim binomial \space neg \left(d_t,d_t+\frac{d_t^2}{\phi} \right)$$
$$\phi \sim N^+(0,5)$$
donde $\phi$ tiene una distribución normal truncada. El número esperado de muertes $d$ en un determinado día es una función de el número de infecciones $c$ que ocurrieron en días previos. Para poder unir las muertes con los casos infectados, se utilizó la tasa de mortalidad por infección ($ifr$,infection mortality rate en inglés) que toma en cuenta tanto a los detectados como los no detectados (recordemos que la tasa de letalidad solo contempla a los detectados mientras la tasa de mortalidad por infección contempla a todas las personas infectadas) y la utilizando el tiempo que pasa entre la infección y la muerte, la cual denotamos con $pi$. Si bien no hay un dato para México, se utilizó la tasa de mortalidad por infección reportado en el mismo estudio. Este valor correspondió a 0.9%.








